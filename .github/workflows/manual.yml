# This is a basic workflow that is manually triggered

name: Manual workflow

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  push:
#   workflow_dispatch:
#     # Inputs the workflow accepts.
#     inputs:
#       name:
#         # Friendly description to be shown in the UI instead of 'name'
#         description: 'Person to greet'
#         # Default value if no value is explicitly provided
#         default: 'World'
#         # Input has to be provided for the workflow to run
#         required: true

jobs:

  # Gets the changed yaml files from the Deployments directory
  changes:
    continue-on-error: false
    runs-on: self-hosted
    outputs:
      deployments: ${{ steps.filter.outputs.deployments }}
      deployments_files: ${{ steps.filter.outputs.deployments_files }}
      changed_directories: ${{ steps.filter.outputs.changed_output }}
    steps:
      # Checkout Repo
      - uses: actions/checkout@v2
      # Set up Filter
      - uses: dorny/paths-filter@v2.9.3
        id: filter
        with:
          list-files: shell
          filters: |
            deployments:
              - added|modified: '**/*.yaml'
          base: 'dev'
          initial-fetch-depth: '10'
          working-directory: 'Deployments'
      - id: script
        run: |
          input=${{ steps.filter.outputs.deployments_files }} && \
          test=$(go run detectChanges.go $input) && \
          echo '::set-output name=changed_output::$(echo $test)'
      - id: test
        run : |
          echo ${{ steps.script.outputs.changed_output }}

  # Uses the changes job to get the unique directories for each change found
  get_Unique_Directories:
    continue-on-error: true
    needs: changes
    if: ${{ needs.changes.outputs.deployments == 'true' }}
    runs-on: self-hosted
    steps:
      # Checkout Repo
      - uses: actions/checkout@v2
      # Setup Go
#      - uses: actions/setup-go@v2.1.3
#        with:
#          go-version: '^1.16'
#        id: directories
      - run: |
          echo "Start -- ${{ needs.changes.outputs.deployments_files }} -- End" && \
          echo "Start -- ${{ needs.changes.outputs.changed_directories }} -- End"

#  # Prints the unique directories found from the previous step
#  print_Directories:
#    continue-on-error: true
#    needs: changes
#    runs-on: self-hosted
#    steps:
#      - run: echo ${{ needs.changes.outputs.directories }}