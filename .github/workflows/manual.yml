# This is a basic workflow that is manually triggered

name: Manual workflow

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  push:
#   workflow_dispatch:
#     # Inputs the workflow accepts.
#     inputs:
#       name:
#         # Friendly description to be shown in the UI instead of 'name'
#         description: 'Person to greet'
#         # Default value if no value is explicitly provided
#         default: 'World'
#         # Input has to be provided for the workflow to run
#         required: true

jobs:

  # Gets the changed yaml files from the Deployments directory
  Format_Changed_Directories:
    continue-on-error: false
    runs-on: self-hosted
    outputs:
      deployments: ${{ steps.filter.outputs.deployments }}
      deployments_files: ${{ steps.filter.outputs.deployments_files }}
      unique_directories: ${{ steps.script.outputs.unique_directories }}
    steps:
      # Checkout Repo
      - uses: actions/checkout@v2
      # Set up Filter
      - uses: dorny/paths-filter@v2.9.3
        id: filter
        with:
          list-files: json
          filters: |
            deployments:
              - added|modified: '**/*.yaml'
          base: 'dev'
          initial-fetch-depth: '10'
          working-directory: 'Deployments'
      - id: script
        run: |
          changedFilePaths='${{ steps.filter.outputs.deployments_files }}' && \
          uniqueDirectories=$(go run detectChanges.go $changedFilePaths) && \
          echo "::set-output name=unique_directories::$uniqueDirectories"

  # Uses the changes job to get the unique directories for each change found
  Matrix_Deployment:
    continue-on-error: true
    needs: Format_Changed_Directories
    if: ${{ needs.Format_Changed_Directories.outputs.deployments == 'true' }}
    runs-on: self-hosted
#    strategy:
#      matrix: ${{fromJson(needs.Format_Changed_Directories.outputs.unique_directories)}}
    steps:
      - uses: actions/checkout@v2
      - run: |
          echo "Found The following edited files: ${{ needs.Format_Changed_Directories.outputs.deployments_files }}"
          echo "Running Matrix to deploy: ${{ needs.Format_Changed_Directories.outputs.changed_directories }}"
          echo "Deploy: ${{ matrix.include }}"